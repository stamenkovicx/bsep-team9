<div class="dashboard-container">
  <!-- NEULOGEVANI KORISNIK -->
  <div *ngIf="!isLoggedIn()" class="not-logged-in">
    <div class="welcome-message">
      <mat-icon class="welcome-icon">security</mat-icon>
      <h1>Welcome to PKI System</h1>
      <p>Please log in to manage your certificates and access all features</p>
      <button mat-raised-button color="primary" routerLink="/login" class="login-btn">
        <mat-icon>login</mat-icon>
        Login to Continue
      </button>
    </div>
  </div>

  <div *ngIf="isLoggedIn()">
    <div class="dashboard-header">
      <h1>PKI SYSTEM DASHBOARD</h1>
      <p>Manage your certificates and certificate authorities</p>
    </div>

    <!-- âœ… SUCCESS/ERROR MESSAGE -->
    <mat-card *ngIf="message.text" [class]="'message-alert ' + message.type">
      <mat-card-content>
        <div class="message-content">
          <mat-icon>{{ message.type === 'success' ? 'check_circle' : 'error' }}</mat-icon>
          <span>{{ message.text }}</span>
          <button mat-icon-button (click)="clearMessage()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="quick-actions">
      <!-- ADMIN / CA -->
      <div *ngIf="isAdmin() || isCA()" class="action-card" routerLink="/certificates/view">
        <mat-icon class="action-icon">list_alt</mat-icon>
        <h3>{{ isAdmin() ? 'Cert List' : 'Chain View' }}</h3>
        <p>{{ isAdmin() ? 'View all certificates' : 'View certificate chain' }}</p>
      </div>

      <!-- SVI ULOGOVANI -->
      <div class="action-card" routerLink="/certificates/my-certificates">
        <mat-icon class="action-icon">folder_special</mat-icon>
        <h3>My Certs</h3>
        <p>View your certificates</p>
      </div>

      <!-- SAMO ADMIN / CA -->
      <div *ngIf="isAdmin() || isCA()" class="action-card" routerLink="/certificates/create">
        <mat-icon class="action-icon">add_circle</mat-icon>
        <h3>Create New</h3>
        <p>Issue new certificate</p>
      </div>
    </div>

    <div class="recent-certificates">
      <div class="section-header">
        <h2>Recent Certificates</h2>
        <button *ngIf="!isLoading && recentCertificates.length > 0" 
                mat-stroked-button 
                color="primary" 
                routerLink="/certificates/view"
                class="show-all-btn">
          Show All
        </button>
      </div>
      
      <div *ngIf="isLoading" class="loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading certificates...</p>
      </div>

      <div *ngIf="!isLoading && recentCertificates.length === 0" class="no-certificates">
        <mat-icon>info</mat-icon>
        <p>No certificates found. Create your first certificate!</p>
        <button mat-raised-button color="primary" routerLink="/certificates/create" class="create-first-btn">
          Create First Certificate
        </button>
      </div>

      <!-- âœ… UPGRADED CERTIFICATE LIST -->
      <div class="certificate-list" *ngIf="!isLoading && recentCertificates.length > 0">
        <div class="certificate-item" *ngFor="let cert of recentCertificates">
          <div class="cert-icon">
            <mat-icon [class]="'status-icon ' + cert.status.toLowerCase()">
              {{ getStatusIcon(cert.status) }}
            </mat-icon>
          </div>
          
          <div class="certificate-info">
            <strong>{{ extractCommonName(cert.subject) }}</strong>
            <span class="cert-type">({{ cert.type }})</span>
            
            <!-- âœ… REVOKED INFO -->
            <div *ngIf="cert.status === 'REVOKED'" class="revoked-info">
              <small>
                ðŸš« Revoked: {{ getRevocationReasonLabel(cert.revocationReason || '') }}
              </small>
            </div>
          </div>
          
          <span class="cert-status" [class]="cert.status.toLowerCase()">
            {{ cert.status }}
          </span>

          <!-- âœ… ACTION BUTTONS -->
          <div class="cert-actions" *ngIf="isAdmin() || isCA()">
            <!-- Revoke Button -->
            <button *ngIf="canRevoke(cert)" 
                    mat-icon-button 
                    color="warn"
                    (click)="openRevokeDialog(cert)"
                    matTooltip="Revoke Certificate">
              <mat-icon>cancel</mat-icon>
            </button>

            <!-- Download CRL -->
            <button *ngIf="canRevoke(cert)"
                    mat-icon-button
                    (click)="downloadCRL(cert)"
                    matTooltip="Download CRL">
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… REVOCATION DIALOG -->
<ng-template #revokeDialog>
  <h2 mat-dialog-title>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <mat-icon color="warn">warning</mat-icon>
      <span>Revoke Certificate</span>
    </div>
  </h2>
  
  <mat-dialog-content>
    <div class="revoke-dialog-content">
      <div class="cert-details">
        <p><strong>Serial Number:</strong></p>
        <p class="serial-mono">{{ selectedCertificate?.serialNumber }}</p>
        
        <p><strong>Subject:</strong></p>
        <p>{{ extractCommonName(selectedCertificate?.subject || '') }}</p>
      </div>
      
      <mat-card class="warning-card">
        <mat-card-content>
          <div style="display: flex; gap: 1rem; align-items: flex-start;">
            <mat-icon style="color: #ff9800;">info</mat-icon>
            <p style="margin: 0;">
              <strong>Warning:</strong> This action is irreversible. The revoked certificate 
              will not be able to issue new certificates.
            </p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-form-field appearance="outline" style="width: 100%; margin-top: 1rem;">
        <mat-label>Revocation Reason (X.509 Standard) *</mat-label>
        <mat-select [(value)]="selectedReason" required>
          <mat-option *ngFor="let reason of revocationReasons" [value]="reason.value">
            {{ reason.label }} - {{ reason.description }}
          </mat-option>
        </mat-select>
        <mat-error>Please select a revocation reason</mat-error>
      </mat-form-field>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="closeDialog()" [disabled]="revoking">
      Cancel
    </button>
    <button mat-raised-button 
            color="warn" 
            [disabled]="!selectedReason || revoking"
            (click)="confirmRevoke()">
      <mat-spinner *ngIf="revoking" diameter="20" style="display: inline-block; margin-right: 0.5rem;"></mat-spinner>
      <mat-icon *ngIf="!revoking">cancel</mat-icon>
      {{ revoking ? 'Revoking...' : 'Confirm Revocation' }}
    </button>
  </mat-dialog-actions>
</ng-template>