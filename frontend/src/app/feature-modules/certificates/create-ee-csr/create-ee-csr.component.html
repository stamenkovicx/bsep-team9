<div class="certificate-form-container">
    <div class="certificate-card">
        <!-- Template banner -->
        <div *ngIf="hasTemplate()" class="template-banner">
            <mat-icon>description</mat-icon>
            <span>Using template: <strong>{{ getTemplateName() }}</strong></span>
        </div>

        <!-- Template CN validation warning -->
        <div *ngIf="hasTemplate() && getTemplateCNPattern() && getTemplateCNPattern() !== '.*'" 
             class="template-warning">
            <mat-icon>info</mat-icon>
            <span>Common Name must match pattern: <code>{{ getTemplateCNPattern() }}</code></span>
        </div>

        <button *ngIf="isCA()" mat-stroked-button color="accent" 
          routerLink="/templates" class="template-header-button">
        <mat-icon>description</mat-icon>
        USE TEMPLATE
        </button>
        
        <h2>Issue End-Entity Certificate via CSR</h2>

        <form [formGroup]="csrForm" (ngSubmit)="onSubmit()" class="certificate-form">

            <fieldset>
                <h3>1. Subject Details and Key Generation</h3>
                <p class="form-instruction">Enter the subject details (certificate owner). This information is used to generate the CSR and the private key.</p>

                <div class="form-group">
                    <label for="commonName">Common Name (CN) *</label>
                    <input type="text" id="commonName" formControlName="commonName" 
                           placeholder="e.g. www.mysite.com" required
                           [class.error]="csrForm.get('commonName')?.hasError('patternMismatch')">
                    <!-- Template pattern error message -->
                    <p *ngIf="csrForm.get('commonName')?.hasError('patternMismatch')" class="error-message template-error">
                        ❌ Common Name doesn't match template pattern: {{ getTemplateCNPattern() }}
                    </p>
                    <p *ngIf="csrForm.get('commonName')?.invalid && csrForm.get('commonName')?.touched && !csrForm.get('commonName')?.hasError('patternMismatch')" 
                       class="error-message">
                        Common Name is required
                    </p>
                </div>

                <div class="form-group">
                    <label for="emailAddress">Email Address *</label>
                    <input type="email" id="emailAddress" formControlName="emailAddress" placeholder="e.g. user@domain.com" required>
                    <p *ngIf="csrForm.get('emailAddress')?.invalid && csrForm.get('emailAddress')?.touched" class="error-message">Valid Email Address is required</p>
                </div>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="organization">Organization (O) *</label>
                        <input type="text" id="organization" formControlName="organization" placeholder="BSEP PKI" required>
                        <p *ngIf="csrForm.get('organization')?.invalid && csrForm.get('organization')?.touched" class="error-message">Organization is required</p>
                    </div>

                    <div class="form-group half-width">
                        <label for="organizationalUnit">Organizational Unit (OU) *</label>
                        <input type="text" id="organizationalUnit" formControlName="organizationalUnit" placeholder="IT" required>
                        <p *ngIf="csrForm.get('organizationalUnit')?.invalid && csrForm.get('organizationalUnit')?.touched" class="error-message">Organizational Unit is required</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="locality">Locality (L) *</label>
                        <input type="text" id="locality" formControlName="locality" placeholder="New York" required>
                        <p *ngIf="csrForm.get('locality')?.invalid && csrForm.get('locality')?.touched" class="error-message">Locality is required</p>
                    </div>
                    
                    <div class="form-group half-width">
                        <label for="state">State/Province (ST) *</label>
                        <input type="text" id="state" formControlName="state" placeholder="NY" required>
                        <p *ngIf="csrForm.get('state')?.invalid && csrForm.get('state')?.touched" class="error-message">State is required</p>
                    </div>
                </div>

                <div class="form-group country-field">
                    <label for="country">Country (C) - 2 letters *</label>
                    <input type="text" id="country" formControlName="country" placeholder="US" maxlength="2" required>
                    <p *ngIf="csrForm.get('country')?.invalid && csrForm.get('country')?.touched" class="error-message">Country is required (2 letters)</p>
                </div>
                
                <div class="form-group generate-btn-wrapper">
                    <button type="button" 
                            (click)="generateCsrAndKey()" 
                            [class.disabled]="csrForm.invalid || isLoading || !!csrForm.get('csrPem')?.value"
                            class="btn btn-primary btn-large">
                        <span *ngIf="isLoading" class="loading-icon">...</span>
                        {{ isLoading ? 'Generating Key...' : (csrForm.get('csrPem')?.value ? 'CSR Generated ✅' : 'Generate Private Key and CSR') }}
                    </button>
                </div>
            </fieldset>

            <div class="divider"></div>

            <fieldset>
                <h3>2. Certificate Signing Request (CSR) Preview</h3>

                <div class="form-group">
                    <label for="csrPem">Generated CSR (PEM format):</label>
                    
                    <div *ngIf="csrForm.get('csrPem')?.value" class="alert-success">
                        <span>✅</span>
                        CSR successfully generated and ready for submission. **Private Key automatically downloaded!**
                    </div>
                    
                    <textarea id="csrPem" 
                              formControlName="csrPem" 
                              placeholder="The CSR will appear here automatically after key generation..." 
                              rows="10" 
                              readonly 
                              required
                              [disabled]="true"></textarea>
                    <p *ngIf="csrForm.get('csrPem')?.invalid && csrForm.get('csrPem')?.touched" class="error-message">CSR must be generated before submission.</p>
                </div>
            </fieldset>
            
            <div class="divider"></div>
            
            <fieldset>
                <h3>3. Issuer and Validity Period</h3>

                <div class="form-group">
                    <label for="issuerCertificateId">Select Issuer (CA) *</label>
                    <select id="issuerCertificateId" formControlName="issuerCertificateId" required [class.disabled]="issuersLoading">
                        <option [ngValue]="null" disabled>-- Select CA Certificate --</option>
                        <option *ngIf="issuersLoading">Loading...</option>
                        <option *ngFor="let issuer of issuers" [ngValue]="issuer.id">
                            {{ extractCommonName(issuer.subject) }} (Serial: {{ issuer.serialNumber }})
                        </option>
                    </select>
                    <!-- Template info za issuer -->
                    <div *ngIf="hasTemplate()" class="template-field-info">
                        <mat-icon>lock</mat-icon>
                        <span>Issuer is predefined by template</span>
                    </div>
                    <p *ngIf="csrForm.get('issuerCertificateId')?.invalid && csrForm.get('issuerCertificateId')?.touched" class="error-message">Issuer CA is required</p>
                </div>

                <div class="form-group">
                    <label for="validTo">Valid Until *</label>
                    <input type="date" id="validTo" formControlName="validTo" required
                           [disabled]="hasTemplate()"> <!-- Onemoguci ako ima template -->
                    <!-- Template info za validity -->
                    <div *ngIf="hasTemplate()" class="template-field-info">
                        <mat-icon>lock</mat-icon>
                        <span>Validity period is predefined by template (max {{ templateData?.maxValidityDays }} days)</span>
                    </div>
                    <p *ngIf="csrForm.get('validTo')?.invalid && csrForm.get('validTo')?.touched" class="error-message">Valid To date is required</p>
                </div>
            </fieldset>

            <div class="divider"></div>

            <div class="form-group submit-btn-wrapper">
                <button type="submit" [class.disabled]="csrForm.invalid || isLoading || !csrForm.get('csrPem')?.value" class="btn btn-primary btn-large">
                    <span *ngIf="isLoading" class="loading-icon">...</span>
                    {{ isLoading ? 'Issuing...' : 'Issue End-Entity Certificate' }}
                </button>
            </div>
        </form>

    </div>

    <div *ngIf="showSuccessMessage" class="success-overlay">
    <div class="success-panel-modal">
        <h3>✅ Certificate Successfully Issued!</h3>
        <p>The End-Entity certificate has been successfully created and saved. You can download it now:</p>
        
        <div class="success-actions">
            <button (click)="onDownloadCertificate()" class="btn btn-primary btn-large">
                <span>⬇️</span>
                Download Certificate (.cer)
            </button>
            <button (click)="onBackToList()" class="btn btn-secondary btn-large">
                <span>📋</span>
                Back to Certificate List
            </button>
        </div>
    </div>
</div>